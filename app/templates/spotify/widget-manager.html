{% extends "base.html" %}

{% block title %}Spotify Widget Studio{% endblock title %}

{% block head_content %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/spotify/widget-manager/widget-manager.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock head_content %}

{% block content %}
<section class="widget-manager-page">
    <div class="container widget-manager-container">
        <div class="wm-root">
            <!-- Top Bar -->
            <header class="wm-topbar">
                <div class="wm-title-group">
                    <h1>Widget Studio</h1>
                    <p>Tasarlayın, özelleştirin, sitenize ekleyin.</p>
                </div>
                <div class="wm-actions">
                    <button class="btn btn-primary" id="getEmbedCodeBtn" data-bs-toggle="modal" data-bs-target="#embedModal">
                        <i class="fas fa-code me-2"></i>Kodu Al
                    </button>
                </div>
            </header>

            <!-- THEME GALLERY (READY-MADE THEMES) -->
            <section class="widget-showcase panel-card">
                <h2 class="section-title">
                    Hazır Temalar
                </h2>
                <p class="text-muted text-center mb-3" style="font-size: 0.9rem;">
                    Aşağıdan bir tema seçin, detaylı ayar ve canlı önizleme için stüdyo modali otomatik olarak açılsın.
                </p>
                <div class="carousel-container">
                    <button class="carousel-btn" id="themeCarouselPrev" type="button" aria-label="Önceki tema">
                        <i class="fas fa-chevron-left"></i>
                    </button>

                    <div class="theme-carousel" id="themeCarousel">
                        <!-- Modern Theme Card -->
                        <article class="theme-card" data-theme="modern" data-theme-label="Modern" data-bs-toggle="modal" data-bs-target="#themeStudioModal">
                            <div class="card-preview modern-preview">
                                <div class="silhouette-modern">
                                    <div class="s-bg-image"></div>
                                    <div class="s-overlay"></div>
                                    <div class="s-content">
                                        <div class="s-info">
                                            <div class="s-title"></div>
                                            <div class="s-artist"></div>
                                        </div>
                                        <div class="s-controls">
                                            <div class="s-progress">
                                                <div class="s-bar"></div>
                                            </div>
                                            <div class="s-timestamps">
                                                <div class="s-time"></div>
                                                <div class="s-time"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-info">
                                <h3>Modern</h3>
                                <p>Dinamik, animasyonlu ve dikkat çekici bir görünüm.</p>
                            </div>
                            <div class="check-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </article>

                        <!-- Classic Theme Card -->
                        <article class="theme-card" data-theme="classic" data-theme-label="Klasik" data-bs-toggle="modal" data-bs-target="#themeStudioModal">
                            <div class="card-preview classic-preview">
                                <div class="silhouette-classic">
                                    <div class="s-cover"></div>
                                    <div class="s-right-col">
                                        <div class="s-info">
                                            <div class="s-title"></div>
                                            <div class="s-artist"></div>
                                        </div>
                                        <div class="s-controls">
                                            <div class="s-progress">
                                                <div class="s-bar"></div>
                                            </div>
                                            <div class="s-timestamps">
                                                <div class="s-time"></div>
                                                <div class="s-time"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-info">
                                <h3>Klasik</h3>
                                <p>Yatay, sade ve her ortama uyumlu bir tasarım.</p>
                            </div>
                            <div class="check-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </article>

                        <!-- Coming Soon Card -->
                        <article class="theme-card coming-soon">
                            <div class="card-preview coming-soon-preview d-flex align-items-center justify-content-center">
                                <span class="text-muted small">Yakında yeni temalar eklenecek</span>
                            </div>
                            <div class="card-info">
                                <h3>Yakında</h3>
                                <p>Yeni widget şablonları üzerinde çalışıyoruz.</p>
                            </div>
                        </article>
                    </div>

                    <button class="carousel-btn" id="themeCarouselNext" type="button" aria-label="Sonraki tema">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </section>

            <!-- SAVED WIDGETS GALLERY -->
            <section class="panel-card">
                <div class="section-header">
                    <h3>
                        <i class="fas fa-layer-group me-2"></i>Kayıtlı Widget'ların
                    </h3>
                </div>
                <div id="savedWidgetsContainer" class="saved-widgets-container">
                    <div class="text-center text-muted py-4 small">
                        <i class="fas fa-spinner fa-spin me-2"></i> Kayıtlı widgetlar yükleniyor...
                    </div>
                </div>
            </section>
        </div>
    </div>
</section>

<!-- THEME STUDIO MODAL (COMPACT CUSTOMIZATION + PREVIEW) -->
<div class="modal fade" id="themeStudioModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen theme-studio-modal-dialog">
        <div class="modal-content theme-studio-modal-content">
            <div class="theme-studio-header">
                <div class="theme-studio-title-group">
                    <span class="badge rounded-pill bg-success-subtle text-success">
                        <i class="fas fa-palette me-1"></i>Spotify Widget
                    </span>
                    <h5 class="modal-title" id="themeStudioModalTitle">
                        Widget Stüdyosu
                    </h5>
                    <p class="text-muted small mb-0">
                        Soldan canlı önizlemeyi takip et, sağdan hareket stilini seç; her şey otomatik kaydedilir.
                    </p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>

            <div class="theme-studio-body">
                <!-- LEFT: PREVIEW -->
                <div class="theme-studio-left">
                    <div class="panel-card preview-section">
                        <div class="section-header">
                            <h3><i class="fas fa-desktop me-2"></i>Canlı Önizleme</h3>
                            <div class="d-flex gap-2">
                                <button id="changeTrackBtn" class="btn-refresh" type="button" title="Şarkıyı değiştir">
                                    <i class="fas fa-random"></i>
                                </button>
                                <button id="refreshPreview" class="btn-refresh" type="button" title="Yenile">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>

                        <div class="preview-container">
                            <div class="iframe-wrapper" style="width: 350px; height: 180px;">
                                <iframe id="widgetPreviewFrame" src="" title="Widget Preview" scrolling="no"></iframe>
                            </div>
                        </div>
                        <div class="preview-note">
                            <i class="fas fa-info-circle me-1"></i> Önizleme demo verilerle çalışır; gerçek Spotify hesabınıza dokunulmaz.
                        </div>
                    </div>
                </div>

                <!-- RIGHT: SETTINGS -->
                <div class="theme-studio-right">
                    <div class="panel-card settings-card">
                        <div class="theme-studio-settings-header">
                            <h3><i class="fas fa-sliders-h me-2"></i>Görünüm Ayarları</h3>
                            <p class="text-muted small mb-0">
                                3 saniyede genel hareket stilini seç; gelişmiş kontrole gerek yok.
                            </p>
                        </div>

                        <div id="themeSettingsContainer">
                            <!-- JS will inject settings here based on selected theme -->
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-spinner fa-spin fa-lg"></i>
                                <p class="mt-2 mb-0">Ayarlar yükleniyor...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="theme-studio-footer">
                <span class="text-muted small">
                    Değişikliklerin otomatik kaydedilir ve embed koduna yansır. Dilediğin zaman geri dönüp güncelleyebilirsin.
                </span>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Kapat</button>
                    <button type="button" class="btn btn-outline-success btn-sm" id="saveWidgetBtn" title="Mevcut ayarlarla yeni bir kopya oluştur">
                        <i class="fas fa-save me-2"></i>Kopya Kaydet
                    </button>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#embedModal">
                        <i class="fas fa-code me-2"></i>Kodu Al
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Embed Code Modal -->
<div class="modal fade" id="embedModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Entegrasyon Kodu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                <div class="integration-card">
                    <p class="mb-3">Aşağıdaki kodu web sitenizin <code>&lt;body&gt;</code> etiketinin sonuna ekleyin.</p>
                    <div class="code-area">
                        <textarea id="embedCode" readonly></textarea>
                    </div>
                    <button class="btn-copy-code" id="copyEmbedCode">
                        <i class="far fa-copy"></i> Kodu Kopyala
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Config Injection -->
<script>
    window.beatifyWidgetConfig = {
        token: "{{ widget_token if widget_token else '' }}",
        fullConfig: {{ config | tojson | safe if config else '{}' }},
        initialTheme: "{{ current_theme if current_theme else 'modern' }}",
        widgetsData: {{ widgets_data | tojson | safe }},
        widgetBaseUrl: "{{ url_for('spotify_widget_bp.spotify_widget', widget_token='TOKEN_PLACEHOLDER') }}"
    };
</script>

<!-- JS Dependencies -->
<script src="{{ url_for('static', filename='js/spotify/widget-manager/events/event-bus.js') }}"></script>
<script src="{{ url_for('static', filename='js/spotify/widget-manager/presets/fade-presets.js') }}"></script>
<script src="{{ url_for('static', filename='js/spotify/widget-manager/presets/slide-presets.js') }}"></script>
<script src="{{ url_for('static', filename='js/spotify/widget-manager/presets/zoom-presets.js') }}"></script>
<script src="{{ url_for('static', filename='js/spotify/widget-manager/presets/blur-presets.js') }}"></script>
<script src="{{ url_for('static', filename='js/spotify/widget-manager/presets/reveal-presets.js') }}"></script>
<script src="{{ url_for('static', filename='js/spotify/widget-manager/presets/core-presets.js') }}"></script>
<script src="{{ url_for('static', filename='js/spotify/widget-manager/services/PreviewService.js') }}"></script>
<script src="{{ url_for('static', filename='js/spotify/widget-manager/services/EmbedService.js') }}"></script>
<script src="{{ url_for('static', filename='js/spotify/widget-manager/services/ThemeService.js') }}"></script>
<script src="{{ url_for('static', filename='js/spotify/widget-manager/services/ThemeSettingsService.js') }}"></script>
<script src="{{ url_for('static', filename='js/spotify/widget-manager/main.js') }}"></script>
{% endblock content %}
